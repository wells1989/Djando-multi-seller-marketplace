{% extends 'myapp/base.html' %}

{% block body %}

<div class="flex p-10 justify-center items-center">
    <!-- left div -->
    <div class="">
        <img class="max-h-96"
            src="https://img.freepik.com/free-photo/community-concept-with-hands-people_23-2147993404.jpg?size=626&ext=jpg&ga=GA1.1.1446778661.1706618687&semt=sph"
            alt="">
    </div>

    <!-- right div -->
    <div class="pl-10">
        <div class="text-4xl mb-3">{{ product.name }}</div>
        <div class="mb-4">{{ product.description }}</div>
        <div class="mb-4 text-green-600 font-bold">Â£{{ product.price }}</div>
        <div>
            <button id="checkout-button" class="bg-green-500 text-white px-4 py-2">Buy Now!</button>
        </div>
        <div id="myemail" hidden>
            {{ request.user.email }}
        </div>
    </div>
</div>

<!-- including Stripe CDN for JS, from https://stripe.com/docs/js/including -->
<script src="https://js.stripe.com/v3/"></script>

<script type="text/javascript">
    var stripe = Stripe('{{ stripe_publishable_key }}') // getting the stripe key from context, and using it to initiate a Stripe session

    var checkoutButton = document.getElementById('checkout-button')

    checkoutButton.addEventListener('click', function () {
        console.log('button clicked')
        var email = document.getElementById('myemail').innerText

        if (email.length == 0) {
            alert("Please enter your email address")
            return
        }

        fetch("{% url 'api_checkout_session' id=product.id %}", {
            method: 'POST',
            body: JSON.stringify({ 'email': email })
        })
            /* Above fetch network request: Making a request to the url named 'api_checkout_session' giving the product id
            .stringify converts  JS object (expects an object as it's argument) into a JSON string, converting it e.g. into a JSON string, e.g. {"email": "user@example.com"} This could be good for having multiple pieces of data in key-value pairs etc
            ** alt to above, could do body: email, as the body can just be a single string value (and thus no need for .stringify method)
            */

            .then(function (response) {
                return response.json() // getting the json response, i.e. from the return JsonResponse({'sessionId:checkout_session.id'}) in create_checkout_session view
            }).then(function (session) {
                console.log('Session received:', session);
                return stripe.redirectToCheckout({ sessionId: session.sessionId }); //
            }).then(function (result) {
                if (result.error) {
                    alert(result.error.message);
                }
            }).catch(function (error) {
                console.log('Error:', error);
            });
    });
    /*
    NOTE: in create_checkout_session view, return JsonResponse({'sessionId': checkout_session.id})
    So the first promise parses that response
    the 2nd promise uses the session, i.e. the return value from the 1st promise, and redirects to stripe checkout, using the sessionID as the value of the 'sessionId' key in the response, i.e checkout_session.id
    the 3rd promise takes the result (the return value from the 2nd)  and returns an error alert
    the 4th promise takes the error from the 3rd and console logs it
    */


</script>

{% endblock %}